#!/usr/bin/env bash
set -euo pipefail

BASE="${HOME}/waydroid-images"
CFG="/var/lib/waydroid/waydroid.cfg"

usage() {
  cat <<USAGE
Usage:
  waydroid-switch list
  waydroid-switch status
  waydroid-switch <profile>

Profiles are subdirectories under ${BASE} that contain system.img and vendor.img.
USAGE
}

current_images_path() {
  awk -F'=' '/^images_path[[:space:]]*=/{gsub(/^[[:space:]]+|[[:space:]]+$/, "", $2); print $2; exit}' "$CFG"
}

list_profiles() {
  [ -d "$BASE" ] || return 0
  for d in "$BASE"/*; do
    [ -d "$d" ] || continue
    [ -f "$d/system.img" ] || continue
    [ -f "$d/vendor.img" ] || continue
    basename "$d"
  done | sort
}

switch_to() {
  local profile="$1"
  local img_path="${BASE}/${profile}"

  if [ ! -f "$img_path/system.img" ] || [ ! -f "$img_path/vendor.img" ]; then
    echo "Invalid profile '${profile}'. Need system.img and vendor.img in ${img_path}" >&2
    exit 1
  fi

  echo "Switching Waydroid images to: ${img_path}"

  sudo waydroid session stop >/dev/null 2>&1 || true
  sudo waydroid container stop >/dev/null 2>&1 || true
  sudo sed -i "s#^images_path = .*#images_path = ${img_path}#" "$CFG"

  if [ -z "${DBUS_SESSION_BUS_ADDRESS:-}" ] && [ -n "${XDG_RUNTIME_DIR:-}" ]; then
    export DBUS_SESSION_BUS_ADDRESS="unix:path=${XDG_RUNTIME_DIR}/bus"
  fi

  waydroid session start
  echo "Done. Current images_path: ${img_path}"
}

cmd="${1:-}"
case "$cmd" in
  ""|"-h"|"--help")
    usage
    ;;
  list)
    list_profiles
    ;;
  status)
    cur="$(current_images_path || true)"
    if [ -n "$cur" ]; then
      echo "Current images_path: $cur"
    else
      echo "Could not read current images_path from ${CFG}" >&2
      exit 1
    fi
    ;;
  *)
    switch_to "$cmd"
    ;;
esac
